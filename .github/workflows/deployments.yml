name: Deployments

on:
  workflow_call:
    secrets:
      DOMAIN: { required: true }
      HOST: { required: true }
      USER: { required: true }
      WORKING_PATH: { required: true }
      DATABASE_USER: { required: true }
      DATABASE_PASSWORD: { required: true }
      DATABASE_HOST: { required: true }
      DATABASE_PORT: { required: true }
      SSH_PRIVATE_KEY: { required: true }
      SSH_KNOWN_HOSTS: { required: true }

jobs:
  # This action must create environment. URL of this environment will take from outputs
  deploy:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'synchronize' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: yarn
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          mkdir -p ./packages/deployment/dist/
          echo "$SSH_PRIVATE_KEY" > ./deploy.key
          sudo chmod 600 ./deploy.key
          echo "$SSH_PRIVATE_KEY" > ./packages/deployment/dist/deploy.key
          sudo chmod 600 ./packages/deployment/dist/deploy.key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
      - name: Generate deployment config
        run: |
          yarn deployment pre-pm2 \
            --branch-ref "origin/${{ github.head_ref }}" \
            --domain "colibrijs.io" \
            --host "194.67.121.95" \
            --repository "${{ github.server_url }}/${{ github.repository }}/" \
            --working-path "/root/colibri/" \
            --user "root" \
            --database-user "user" \
            --database-password "password" \
            --database-host "127.0.0.1" \
            --database-port 5432
      - # if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' || github.event.action == 'reopened' }}
        name: "Setup deployment on the remote server"
        run: yarn pm2 deploy ./packages/deployment/dist/deployment.json branch setup
      - name: "Deploy branch to the remote server"
        run: yarn pm2 deploy ./packages/deployment/dist/deployment.json branch

  # This action must remove environment. URL of this environment will take from util
  remove:
    if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: yarn
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          mkdir -p ./packages/deployment/dist/
          echo "$SSH_PRIVATE_KEY" > ./deploy.key
          sudo chmod 600 ./deploy.key
          echo "$SSH_PRIVATE_KEY" > ./packages/deployment/dist/deploy.key
          sudo chmod 600 ./packages/deployment/dist/deploy.key
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
        shell: bash
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Generate deployment removing config
        run: |
          yarn deployment remove \
            --branch-ref "origin/${{ github.head_ref }}" \
            --host ${{ secrets.HOST }} \
            --repository "${{ github.server_url }}/${{ github.repository }}/" \
            --working-path "${{ secrets.WORKING_PATH }}" \
            --user "${{ secrets.USER }}"
      - name: "Remove branch' deployment on the remote server"
        run: yarn pm2 deploy ./packages/deployment/dist/remove-deployment.json remove
